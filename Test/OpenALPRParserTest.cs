using Microsoft.VisualStudio.TestTools.UnitTesting;
using Models.Cars;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Services.Recognition;
using System.Collections.Generic;

namespace Test
{
    [TestClass]
    public class OpenALPRParserTest
    {
        [TestMethod]
        public void TestOneCarParsing()
        {
            OpenALPRParser parser = new OpenALPRParser();
            string data = "{\"plate\": \"HBL585\",\"confidence\": 93.492500305175781,\"region_confidence\": 99,\"vehicle_region\": {\"y\": 52,\"x\": 376,\"height\": 328,\"width\": 328},\"region\": \"eu-lt\",\"plate_index\": 0,\"processing_time_ms\": 73.1680908203125,\"candidates\": [{\"matches_template\": 1,\"plate\": \"HBL585\",\"confidence\": 93.492500305175781}],\"coordinates\": [{\"y\": 257,\"x\": 485},{\"y\": 262,\"x\": 598},{\"y\": 286,\"x\": 595},{\"y\": 280,\"x\": 482}],\"vehicle\": {\"orientation\": [{\"confidence\": 90.603515625,\"name\": \"90\"},{\"confidence\": 5.12770414352417,\"name\": \"45\"},{\"confidence\": 2.1349618434906006,\"name\": \"225\"},{\"confidence\": 1.1525816917419434,\"name\": \"180\"},{\"confidence\": 0.78257173299789429,\"name\": \"135\"},{\"confidence\": 0.1649385541677475,\"name\": \"270\"},{\"confidence\": 0.025618128478527069,\"name\": \"315\" }, {\"confidence\": 0.0077919699251651764,\"name\": \"missing\"},{\"confidence\": 0.0003223512030672282,\"name\": \"0\"}],\"color\": [{\"confidence\": 69.755058288574219, \"name\": \"green\"},{\"confidence\": 28.409921646118164,\"name\": \"yellow\"},{\"confidence\": 1.7912486791610718,\"name\": \"gold-beige\"},{\"confidence\": 0.021887537091970444,\"name\": \"brown\"}, { \"confidence\": 0.018249774351716042,\"name\": \"silver-gray\"}, { \"confidence\": 0.0035143515560775995,\"name\": \"orange\"},{\"confidence\": 8.35103855933994E-05,\"name\": \"black\"},{\"confidence\": 2.3519696696894243E-05,\"name\": \"white\"},{\"confidence\": 7.734758582955692E-06,\"name\": \"blue\"},{\"confidence\": 2.241846914330381E-06,\"name\": \"purple\"}],\"make\": [{\"confidence\": 39.190673828125,\"name\": \"renault\"},{\"confidence\": 36.089267730712891,\"name\": \"fiat\"},{\"confidence\": 12.316061973571777,\"name\": \"citroen\" },{ \"confidence\": 4.9824638366699219,\"name\": \"opel\"},{\"confidence\": 4.6870598793029785,\"name\": \"volkswagen\"},{\"confidence\": 1.5684405565261841,\"name\": \"volvo\"},{\"confidence\": 0.71084147691726685,\"name\": \"peugeot\"},{\"confidence\": 0.17441196739673615,\"name\": \"audi\"},{\"confidence\": 0.11071158945560455,\"name\": \"skoda\"},{\"confidence\": 0.049153748899698257,\"name\": \"mercedes-benz\"}],\"body_type\": [{\"confidence\": 98.326286315917969,\"name\": \"sedan-compact\"},{\"confidence\": 1.4060238599777222,\"name\": \"sedan-standard\"},{\"confidence\": 0.087483771145343781,\"name\": \"tractor-trailer\"},{\"confidence\": 0.059973295778036118,\"name\": \"sedan-convertible\"},{\"confidence\": 0.048898618668317795,\"name\": \"sedan-sports\"},{\"confidence\": 0.042307395488023758,\"name\": \"sedan-wagon\"},{\"confidence\": 0.02641681581735611,\"name\": \"suv-crossover\"},{\"confidence\": 0.0010313693201169372,\"name\": \"van-mini\"},{\"confidence\": 0.000778089975938201,\"name\": \"suv-standard\"},{\"confidence\": 0.00070560351014137268,\"name\": \"antique\"}],\"year\": [{\"confidence\": 78.0697021484375,\"name\": \"1995-1999\"},{\"confidence\": 17.803455352783203,\"name\": \"2000-2004\"},{\"confidence\": 4.0075411796569824,\"name\": \"1990-1994\"},{\"confidence\": 0.087738081812858582,\"name\": \"1985-1989\"},{\"confidence\": 0.020262796431779861,\"name\": \"2005-2009\"},{\"confidence\": 0.011187341064214706,\"name\": \"1980-1984\"},{\"confidence\": 9.3058624770492315E-05,\"name\": \"2010-2014\"},{\"confidence\": 1.306793637922965E-05,\"name\": \"2015-2019\"},{\"confidence\": 1.0664716683095321E-06,\"name\": \"missing\"}],\"make_model\": [{\"confidence\": 30.899778366088867,\"name\": \"opel_astra\"},{\"confidence\": 26.3952693939209,\"name\": \"fiat_punto\"},{\"confidence\": 6.9425344467163086,\"name\": \"volkswagen_golf\"},{\"confidence\": 6.6534085273742676,\"name\": \"renault_clio\"},{\"confidence\": 6.2497682571411133,\"name\": \"renault_megane\"},{\"confidence\": 4.1121196746826172,\"name\": \"fiat_stilo\"},{\"confidence\": 2.9504168033599854,\"name\": \"citroen_saxo\"},{\"confidence\": 1.7517354488372803,\"name\": \"volkswagen_polo\"},{\"confidence\": 1.6696697473526,\"name\": \"volvo_v40\"},{\"confidence\": 1.4648809432983398,\"name\": \"renault_laguna\"}]},\"matches_template\": 1,\"requested_topn\": 10}";
            JObject o = JObject.Parse(data);
            Car car = parser.ParseUnit(o);
            parser.ParseUnit(o);

            Car actualCar = CarFactory.GetInstance().CreateCar("HBL585", "green", "renault", "opel_astra", "sedan-compact", "1995-1999");

            Assert.AreEqual(car.LicensePlate, actualCar.LicensePlate);
            Assert.AreEqual(car.ColorName, actualCar.ColorName);
            Assert.AreEqual(car.MakeName, actualCar.MakeName);
            Assert.AreEqual(car.Model, actualCar.Model);
            Assert.AreEqual(car.BodyType, actualCar.BodyType);
            Assert.AreEqual(car.Year, actualCar.Year);
        }

        [TestMethod]
        public void TestCarsParsing()
        {
            OpenALPRParser parser = new OpenALPRParser();
            string data = "{results:[{\"plate\": \"HBL585\",\"confidence\": 93.492500305175781,\"region_confidence\": 99,\"vehicle_region\": {\"y\": 52,\"x\": 376,\"height\": 328,\"width\": 328},\"region\": \"eu-lt\",\"plate_index\": 0,\"processing_time_ms\": 73.1680908203125,\"candidates\": [{\"matches_template\": 1,\"plate\": \"HBL585\",\"confidence\": 93.492500305175781}],\"coordinates\": [{\"y\": 257,\"x\": 485},{\"y\": 262,\"x\": 598},{\"y\": 286,\"x\": 595},{\"y\": 280,\"x\": 482}],\"vehicle\": {\"orientation\": [{\"confidence\": 90.603515625,\"name\": \"90\"},{\"confidence\": 5.12770414352417,\"name\": \"45\"},{\"confidence\": 2.1349618434906006,\"name\": \"225\"},{\"confidence\": 1.1525816917419434,\"name\": \"180\"},{\"confidence\": 0.78257173299789429,\"name\": \"135\"},{\"confidence\": 0.1649385541677475,\"name\": \"270\"},{\"confidence\": 0.025618128478527069,\"name\": \"315\" }, {\"confidence\": 0.0077919699251651764,\"name\": \"missing\"},{\"confidence\": 0.0003223512030672282,\"name\": \"0\"}],\"color\": [{\"confidence\": 69.755058288574219, \"name\": \"green\"},{\"confidence\": 28.409921646118164,\"name\": \"yellow\"},{\"confidence\": 1.7912486791610718,\"name\": \"gold-beige\"},{\"confidence\": 0.021887537091970444,\"name\": \"brown\"}, { \"confidence\": 0.018249774351716042,\"name\": \"silver-gray\"}, { \"confidence\": 0.0035143515560775995,\"name\": \"orange\"},{\"confidence\": 8.35103855933994E-05,\"name\": \"black\"},{\"confidence\": 2.3519696696894243E-05,\"name\": \"white\"},{\"confidence\": 7.734758582955692E-06,\"name\": \"blue\"},{\"confidence\": 2.241846914330381E-06,\"name\": \"purple\"}],\"make\": [{\"confidence\": 39.190673828125,\"name\": \"renault\"},{\"confidence\": 36.089267730712891,\"name\": \"fiat\"},{\"confidence\": 12.316061973571777,\"name\": \"citroen\" },{ \"confidence\": 4.9824638366699219,\"name\": \"opel\"},{\"confidence\": 4.6870598793029785,\"name\": \"volkswagen\"},{\"confidence\": 1.5684405565261841,\"name\": \"volvo\"},{\"confidence\": 0.71084147691726685,\"name\": \"peugeot\"},{\"confidence\": 0.17441196739673615,\"name\": \"audi\"},{\"confidence\": 0.11071158945560455,\"name\": \"skoda\"},{\"confidence\": 0.049153748899698257,\"name\": \"mercedes-benz\"}],\"body_type\": [{\"confidence\": 98.326286315917969,\"name\": \"sedan-compact\"},{\"confidence\": 1.4060238599777222,\"name\": \"sedan-standard\"},{\"confidence\": 0.087483771145343781,\"name\": \"tractor-trailer\"},{\"confidence\": 0.059973295778036118,\"name\": \"sedan-convertible\"},{\"confidence\": 0.048898618668317795,\"name\": \"sedan-sports\"},{\"confidence\": 0.042307395488023758,\"name\": \"sedan-wagon\"},{\"confidence\": 0.02641681581735611,\"name\": \"suv-crossover\"},{\"confidence\": 0.0010313693201169372,\"name\": \"van-mini\"},{\"confidence\": 0.000778089975938201,\"name\": \"suv-standard\"},{\"confidence\": 0.00070560351014137268,\"name\": \"antique\"}],\"year\": [{\"confidence\": 78.0697021484375,\"name\": \"1995-1999\"},{\"confidence\": 17.803455352783203,\"name\": \"2000-2004\"},{\"confidence\": 4.0075411796569824,\"name\": \"1990-1994\"},{\"confidence\": 0.087738081812858582,\"name\": \"1985-1989\"},{\"confidence\": 0.020262796431779861,\"name\": \"2005-2009\"},{\"confidence\": 0.011187341064214706,\"name\": \"1980-1984\"},{\"confidence\": 9.3058624770492315E-05,\"name\": \"2010-2014\"},{\"confidence\": 1.306793637922965E-05,\"name\": \"2015-2019\"},{\"confidence\": 1.0664716683095321E-06,\"name\": \"missing\"}],\"make_model\": [{\"confidence\": 30.899778366088867,\"name\": \"opel_astra\"},{\"confidence\": 26.3952693939209,\"name\": \"fiat_punto\"},{\"confidence\": 6.9425344467163086,\"name\": \"volkswagen_golf\"},{\"confidence\": 6.6534085273742676,\"name\": \"renault_clio\"},{\"confidence\": 6.2497682571411133,\"name\": \"renault_megane\"},{\"confidence\": 4.1121196746826172,\"name\": \"fiat_stilo\"},{\"confidence\": 2.9504168033599854,\"name\": \"citroen_saxo\"},{\"confidence\": 1.7517354488372803,\"name\": \"volkswagen_polo\"},{\"confidence\": 1.6696697473526,\"name\": \"volvo_v40\"},{\"confidence\": 1.4648809432983398,\"name\": \"renault_laguna\"}]},\"matches_template\": 1,\"requested_topn\": 10},{\"plate\": \"HBL585\",\"confidence\": 93.492500305175781,\"region_confidence\": 99,\"vehicle_region\": {\"y\": 52,\"x\": 376,\"height\": 328,\"width\": 328},\"region\": \"eu-lt\",\"plate_index\": 0,\"processing_time_ms\": 73.1680908203125,\"candidates\": [{\"matches_template\": 1,\"plate\": \"HBL585\",\"confidence\": 93.492500305175781}],\"coordinates\": [{\"y\": 257,\"x\": 485},{\"y\": 262,\"x\": 598},{\"y\": 286,\"x\": 595},{\"y\": 280,\"x\": 482}],\"vehicle\": {\"orientation\": [{\"confidence\": 90.603515625,\"name\": \"90\"},{\"confidence\": 5.12770414352417,\"name\": \"45\"},{\"confidence\": 2.1349618434906006,\"name\": \"225\"},{\"confidence\": 1.1525816917419434,\"name\": \"180\"},{\"confidence\": 0.78257173299789429,\"name\": \"135\"},{\"confidence\": 0.1649385541677475,\"name\": \"270\"},{\"confidence\": 0.025618128478527069,\"name\": \"315\" }, {\"confidence\": 0.0077919699251651764,\"name\": \"missing\"},{\"confidence\": 0.0003223512030672282,\"name\": \"0\"}],\"color\": [{\"confidence\": 69.755058288574219, \"name\": \"green\"},{\"confidence\": 28.409921646118164,\"name\": \"yellow\"},{\"confidence\": 1.7912486791610718,\"name\": \"gold-beige\"},{\"confidence\": 0.021887537091970444,\"name\": \"brown\"}, { \"confidence\": 0.018249774351716042,\"name\": \"silver-gray\"}, { \"confidence\": 0.0035143515560775995,\"name\": \"orange\"},{\"confidence\": 8.35103855933994E-05,\"name\": \"black\"},{\"confidence\": 2.3519696696894243E-05,\"name\": \"white\"},{\"confidence\": 7.734758582955692E-06,\"name\": \"blue\"},{\"confidence\": 2.241846914330381E-06,\"name\": \"purple\"}],\"make\": [{\"confidence\": 39.190673828125,\"name\": \"renault\"},{\"confidence\": 36.089267730712891,\"name\": \"fiat\"},{\"confidence\": 12.316061973571777,\"name\": \"citroen\" },{ \"confidence\": 4.9824638366699219,\"name\": \"opel\"},{\"confidence\": 4.6870598793029785,\"name\": \"volkswagen\"},{\"confidence\": 1.5684405565261841,\"name\": \"volvo\"},{\"confidence\": 0.71084147691726685,\"name\": \"peugeot\"},{\"confidence\": 0.17441196739673615,\"name\": \"audi\"},{\"confidence\": 0.11071158945560455,\"name\": \"skoda\"},{\"confidence\": 0.049153748899698257,\"name\": \"mercedes-benz\"}],\"body_type\": [{\"confidence\": 98.326286315917969,\"name\": \"sedan-compact\"},{\"confidence\": 1.4060238599777222,\"name\": \"sedan-standard\"},{\"confidence\": 0.087483771145343781,\"name\": \"tractor-trailer\"},{\"confidence\": 0.059973295778036118,\"name\": \"sedan-convertible\"},{\"confidence\": 0.048898618668317795,\"name\": \"sedan-sports\"},{\"confidence\": 0.042307395488023758,\"name\": \"sedan-wagon\"},{\"confidence\": 0.02641681581735611,\"name\": \"suv-crossover\"},{\"confidence\": 0.0010313693201169372,\"name\": \"van-mini\"},{\"confidence\": 0.000778089975938201,\"name\": \"suv-standard\"},{\"confidence\": 0.00070560351014137268,\"name\": \"antique\"}],\"year\": [{\"confidence\": 78.0697021484375,\"name\": \"1995-1999\"},{\"confidence\": 17.803455352783203,\"name\": \"2000-2004\"},{\"confidence\": 4.0075411796569824,\"name\": \"1990-1994\"},{\"confidence\": 0.087738081812858582,\"name\": \"1985-1989\"},{\"confidence\": 0.020262796431779861,\"name\": \"2005-2009\"},{\"confidence\": 0.011187341064214706,\"name\": \"1980-1984\"},{\"confidence\": 9.3058624770492315E-05,\"name\": \"2010-2014\"},{\"confidence\": 1.306793637922965E-05,\"name\": \"2015-2019\"},{\"confidence\": 1.0664716683095321E-06,\"name\": \"missing\"}],\"make_model\": [{\"confidence\": 30.899778366088867,\"name\": \"opel_astra\"},{\"confidence\": 26.3952693939209,\"name\": \"fiat_punto\"},{\"confidence\": 6.9425344467163086,\"name\": \"volkswagen_golf\"},{\"confidence\": 6.6534085273742676,\"name\": \"renault_clio\"},{\"confidence\": 6.2497682571411133,\"name\": \"renault_megane\"},{\"confidence\": 4.1121196746826172,\"name\": \"fiat_stilo\"},{\"confidence\": 2.9504168033599854,\"name\": \"citroen_saxo\"},{\"confidence\": 1.7517354488372803,\"name\": \"volkswagen_polo\"},{\"confidence\": 1.6696697473526,\"name\": \"volvo_v40\"},{\"confidence\": 1.4648809432983398,\"name\": \"renault_laguna\"}]},\"matches_template\": 1,\"requested_topn\": 10}]}";
            List<Car> cars = parser.Parse(data);

            Car actualCar = CarFactory.GetInstance().CreateCar("HBL585", "green", "renault", "opel_astra", "sedan-compact", "1995-1999");

            foreach (Car car in cars)
            {
                Assert.AreEqual(car.LicensePlate, actualCar.LicensePlate);
                Assert.AreEqual(car.ColorName, actualCar.ColorName);
                Assert.AreEqual(car.MakeName, actualCar.MakeName);
                Assert.AreEqual(car.Model, actualCar.Model);
                Assert.AreEqual(car.BodyType, actualCar.BodyType);
                Assert.AreEqual(car.Year, actualCar.Year);
            }
        }

        [TestMethod]
        [ExpectedException(typeof(JsonReaderException))]
        public void TestParsingException()
        {
            OpenALPRParser parser = new OpenALPRParser();
            parser.Parse("");
        }

        [TestMethod]
        [ExpectedException(typeof(ParseException))]
        public void TestErrorMessageParsingException()
        {
            OpenALPRParser parser = new OpenALPRParser();
            parser.Parse("{\"error_code\":\"true\"}");
        }
    }
}
